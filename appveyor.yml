version: 1.7.{build}

pull_requests:
  do_not_increment_build_number: true
  
branches:
  only:
  - master
  - v1.6-dev

os: Visual Studio 2015

configuration: Release

platform:
  - x86
  - x64

environment:
  ROOTSYS: C:\root
  PATH: '%ROOTSYS%\bin;C:\Qt\5.6\msvc2015;C:\Python35;C:\Miniconda35;C:\Miniconda35\\Scripts;%PATH%'
  
#matrix:
#- OPTION: modern
#  platform: x86
#- OPTION: modern
#  platform: x64
#- OPTION: old
#  platform: x86
#- OPTION: old
#  platform: x64

#cache:
#  - %APPVEYOR_BUILD_FOLDER%\extern\ZestSC1
 # - %APPVEYOR_BUILD_FOLDER%\extern\tlufirmware
 # - %APPVEYOR_BUILD_FOLDER%\extern\libusb-win32
  
init:
#- ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

before_build:
- cmd: >-

    del "C:\Program Files (x86)\MSBuild\14.0\Microsoft.Common.targets\ImportAfter\Xamarin.Common.targets"
    
    conda config --set always_yes yes --set changeps1 no
    
    conda info -a
    
    conda create -q -n test-environment numpy
    
    activate test-environment
    
    powershell -command "$clnt = new-object System.Net.WebClient; $clnt.DownloadFile(\"https://root.cern.ch/download/root_v5.34.36.win32.vc12.zip\",\"C:\\root_v5.34.36.win32.vc12.zip\")"
    
    7z -y x C:\\root_v5.34.36.win32.vc12.zip -oC:\

    powershell -command "$clnt = new-object System.Net.WebClient; $clnt.DownloadFile(\"https://www.secure-endpoints.com/binaries/heimdal/Heimdal-AMD64-full-1-6-2-0.msi\",\"C:\\Heimdal-AMD64-full-1-6-2-0.msi\")"
    
    powershell  -command "msiexec /i \"C:\\Heimdal-AMD64-full-1-6-2-0.msi\" /quiet /qn /norestart /log install.log ADDLOCAL=ALL"
    
    powershell -command "$clnt = new-object System.Net.WebClient; $clnt.DownloadFile(\"http://dl.openafs.org/dl/openafs/1.7.31/winxp/openafs-en_US-64bit-1-7-3100.msi\",\"C:\\openafs-en_US-64bit-1-7-3100.msi\")"
    
    powershell  -command "msiexec /i \"C:\\openafs-en_US-64bit-1-7-3100.msi\" /quiet /qn /norestart /log install.log ADDLOCAL=ALL"  
    
    powershell -command "$clnt = new-object System.Net.WebClient; $clnt.DownloadFile(\"http://dl.openafs.org/dl/openafs/1.7.31/winxp/openafs-32bit-tools-en_US-1-7-3100.msi\",\"C:\\openafs-32bit-tools-en_US-1-7-3100.msi\")"
    
    powershell  -command "msiexec /i \"C:\\openafs-32bit-tools-en_US-1-7-3100.msi\" /quiet /qn /norestart /log install.log ADDLOCAL=ALL"      
    
    powershell -command  "Restart-Computer -Force"
    
    powershell -command "Start-Sleep -s 10"

build_script:
- ps: If (Test-Path ("${env:APPVEYOR_BUILD_FOLDER}" + "\extern\ZestSC1")) {Write-Host "Reusing cached ZestSC1 instead of copying from AFS"} Else {Write-Host "Copying ZestSC1 from AFS"; }
#- mkdir %APPVEYOR_BUILD_FOLDER%\extern\ZestSC1

#- xcopy \\afs\desy.de\group\telescopes\tlu\ZestSC1 %APPVEYOR_BUILD_FOLDER%\extern\ZestSC1 /E

- mkdir %APPVEYOR_BUILD_FOLDER%\extern\tlufirmware

- xcopy \\afs\desy.de\group\telescopes\tlu\tlufirmware %APPVEYOR_BUILD_FOLDER%\extern\tlufirmware /E

#- powershell -command "$clnt = new-object System.Net.WebClient; $clnt.DownloadFile(\"https://sourceforge.net/projects/libusb-win32/files/libusb-win32-releases/1.2.6.0/libusb-win32-bin-1.2.6.0.zip\",\"C:\\libusb-win32-bin-1.2.6.0.zip\")"

- ps: appveyor\download.ps1 -downloadLocation 'https://sourceforge.net/projects/libusb-win32/files/libusb-win32-releases/1.2.6.0/libusb-win32-bin-1.2.6.0.zip' -storageLocation 'C:\\libusb-win32-bin-1.2.6.0.zip'

- 7z -y x C:\\libusb-win32-bin-1.2.6.0.zip -o%APPVEYOR_BUILD_FOLDER%\extern\

- move %APPVEYOR_BUILD_FOLDER%\extern\libusb-win32-bin-1.2.6.0 %APPVEYOR_BUILD_FOLDER%\extern\libusb-win32

- dir %APPVEYOR_BUILD_FOLDER%\extern

#- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

- cd %APPVEYOR_BUILD_FOLDER%\build

- cmake -DBUILD_onlinemon=ON -DBUILD_python=OFF -DBUILD_tlu=ON ..

- msbuild INSTALL.vcxproj

on_finish:
#- ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
